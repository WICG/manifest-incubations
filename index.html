<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>
      Manifest Incubations
    </title>
    <script src="https://www.w3.org/Tools/respec/respec-w3c" class=
    "remove"></script>
    <script class='remove'>
      // See https://github.com/w3c/respec/wiki/ for how to configure ReSpec
      var respecConfig = {
        specStatus: "CG-DRAFT",
        editors: [{
          name: "Daniel Murphy"
        }],
        github: "WICG/manifest-incubations",
        shortName: "manifest-incubations",
        xref: {
          specs: ["appmanifest", "dom"],
          profile: "web-platform",
        },
      };
    </script>
  </head>
  <body>
    <section id="abstract">
      <p>
        Feature specifications for <a href=
        "https://www.w3.org/TR/appmanifest/">Web Application Manifest</a>
        extensions & incubations which Chromium has shipped but do not have
        committments / implementations from other user agents. Instead of
        keeping these features as explainers, they are documented more
        officially here.
      </p>
    </section>
    <section id="sotd">
      <p>
        This is an unofficial proposal.
      </p>
    </section>
    <section>
      <h2 data-dfn-for="">
        <code>display_override</code> member
      </h2>
      <p>
        For advanced usages, the display_override member can be used to specify
        a custom fallback order of <a data-cite=
        "appmanifest#dfn-display-modes-values">display mode values</a> for
        developers to choose their prefered <a data-cite=
        "appmanifest#dfn-display-mode">display mode</a>.
      </p>
      <p>
        The <dfn>display_override</dfn> member of the <a data-cite=
        "appmanifest#web-application-manifest">Web Application Manifest</a> is
        a <a>sequence</a> of <a data-cite=
        "appmanifest#dfn-display-modes-values">display mode values</a>. This
        item represents the developer's preferred fallback chain for
        <a data-cite="appmanifest#dfn-display-mode">display modes</a>. This
        field overrides the <a data-cite="appmanifest#display">display</a>
        property. If the user agent does not support any of the display modes
        specified here, then it falls back to considering the <a data-cite=
        "appmanifest#display">display</a> field. See <a data-cite=
        "appmanifest#dfn-display-mode">display modes</a> for the algorithm
        steps.
      </p>
      <p>
        The following steps are added to the <a data-cite=
        "appmanifest#dfn-extension-point">extension point</a> in <a data-cite=
        "appmanifest#dfn-steps-for-determining-the-web-app-s-chosen-display-mode">
        determining the web app's chosen display mode</a>:
      </p>
      <ol>
        <li>[=list/For each=] |candidate_display_mode:DisplayModeType| of
        |manifest|.{{display_override}}:
          <ol>
            <li>If the user agent supports the |candidate_display_mode|, then
            return |candidate_display_mode|.
            </li>
          </ol>
        </li>
      </ol>
      <p class="note">
        This member is intended to be only used for advanced cases, where the
        developer wants explicit control over the fallback order of their
        display modes. Otherwise, the <a data-cite=
        "appmanifest#display">display</a> should be sufficient for most use
        cases.
      </p>
      <section class="informative">
        <h3>
          Usage Example
        </h3>
        <p>
          The following shows a [=manifest=] that prefers the
          <code>minimal-ui</code> <a data-cite=
          "appmanifest#dfn-display-mode">display mode</a> over
          <code>standalone</code>, but if <code>minimal-ui</code> isn't
          supported, falls back to <code>standalone</code> as opposed to
          <code>browser</code>.
        </p>
        <pre class="example json" title="Advanced display usage manifest">
          {
            "name": "Recipe Zone",
            "description": "All of the recipes!",
            "icons": [{
              "src": "icon/hd_hi",
              "sizes": "128x128"
            }],
            "start_url": "/index.html",
            "display_override": ["minimal-ui"],
            "display": "standalone",
            "theme_color": "yellow",
            "background_color": "red"
          }
        </pre>
      </section>
    </section>
    <section>
      <h2 data-dft-for="">
        <code>share_target</code> member
      </h2>
      <p>
        The `share_target` member registers a web application as "target" for
        share actions (e.g., for sharing a text, a URL, or a file). The
        `share_target` member is part of the <a href=
        "https://wicg.github.io/web-share-target/">Web Share Target</a>
        specification, being incubated at the <a href=
        "https://wicg.io">WICG</a>.
      </p>
    </section>
    <section data-cite="DOM">
      <h2>
        Installation prompts
      </h2>
      <p>
        There are multiple ways that the installation process can be triggered:
      </p>
      <ul>
        <li>An end-user can <dfn data-lt="manual installation">manually</dfn>
        trigger the installation process through the user agent's
          <abbr title="User Interface">UI</abbr>, directly invoking the steps
          to <a>present an install prompt</a>.
        </li>
        <li>The installation process can occur through a <dfn>site-triggered
        install prompt</dfn>: the site can programmatically request that the
        user agent present an install prompt to the user. The user agent MAY
        restrict the availability of this feature to cases where, for instance,
        there are sufficient signals to warrant [=installed web application|installation=] of the web application.
        </li>
      </ul>
      <p>
        In any case, the user agent MUST NOT <a>present an install prompt</a>
        if the document is not <a data-cite=
        "appmanifest#dfn-is-installable">installable</a>.
      </p>
      <p>
        The user agent MAY, at any time (only if the document is <a data-cite=
        "appmanifest#dfn-is-installable">installable</a>), run the <a>steps to
        notify that an install prompt is available</a> at any time, giving the
        site the opportunity to show a <a>site-triggered install prompt</a>
        without the user needing to interact with the user agent UI.
      </p>
      <p>
        To <dfn data-local-lt=
        "presenting an install prompt|presentation of the install prompt">present
        an install prompt</dfn>:
      </p>
      <ol>
        <li>Show some user-agent-specific UI, asking the user whether to
        proceed with installing the app. See <a data-cite=
        "appmanifest#installation-sec">privacy and security considerations</a>
        for recommendations relating to this UI. The <var>result</var> of this
        choice is either {{AppBannerPromptOutcome/accepted}} or
        {{AppBannerPromptOutcome/dismissed}}.
        </li>
        <li>Return <var>result</var>, and <a>in parallel</a>:
          <ol>
            <li>If <var>result</var> is {{AppBannerPromptOutcome/accepted}},
            run the <a>steps to install the web application</a>.
            </li>
          </ol>
        </li>
      </ol>
      <p>
        The <dfn>steps to notify that an install prompt is available</dfn> are
        given by the following algorithm:
      </p>
      <ol>
        <li>Wait until the {{Document}} of the <a>top-level browsing
        context</a> is <a data-cite="html#completely-loaded">completely
        loaded</a>.
        </li>
        <li>If there is already an <a data-lt=
        "present an install prompt">install prompt being presented</a> or if
        the <a>steps to install the web application</a> are currently being
        executed, then abort this step.
        </li>
        <li>
          <a>Queue a task</a> on the <a>application life-cycle task source</a>
          to do the following:
          <ol>
            <li>Let <var>event</var> be a newly constructed
            {{BeforeInstallPromptEvent}} named `"beforeinstallprompt"`, with
            its {{Event/cancelable}} attribute initialized to true.
            </li>
            <li>Let <var>mayShowPrompt</var> be the result of [=fire an
            event|fire=] <var>event</var> at the {{Window}} object of the
            <a>top-level browsing context</a>.
            </li>
            <li>If <var>mayShowPrompt</var> is true, then the user agent MAY,
            <a>in parallel</a>, <a>request to present an install prompt</a>
            with <var>event</var>.
            </li>
          </ol>
        </li>
      </ol>
    </section>
    <section data-cite="DOM">
      <h2>
        Installable web applications
      </h2>
      <section>
        <h2>
          Installation process
        </h2>
        <p>
          The <dfn>steps to install the web application</dfn> are given by the
          following algorithm:
        </p>
        <ol>
          <li>Let <var>manifest</var> be the manifest of an <a data-cite=
          "appmanifest#dfn-is-installable">installable</a> document.
          </li>
          <li>Perform an unspecified sequence of actions to attempt to register
          the web application in the user's operating system (e.g., create
          shortcuts that launch the web application, register the application
          in the system uninstall menu, etc.). If the installation fails (which
          can be for any reason, for example, the OS denying permission to the
          user agent to add an icon to the home screen of the device), abort
          these steps.
          </li>
          <li>
            <a>Queue a task</a> on the <a>application life-cycle task
            source</a> to <a>fire an event</a> named <code>appinstalled</code>
            at the the {{Window}} object of the <a>top-level browsing
            context</a> for which the installation took place.
          </li>
        </ol>
      </section>
      <section class="informative">
        <h3 id="installability-signals">
          Installability signals
        </h3>
        <p>
          By design, this specification does not provide developers with an
          explicit API to "install" a web application. Instead, a
          <a>manifest</a> can serve as an <dfn>installability signal</dfn> to a
          user agent that a web application can be <a>installed</a>.
        </p>
        <p>
          Examples of <a>installability signals</a> for a web application:
        </p>
        <ul>
          <li>is <a>associated with a manifest</a> with at least a
          <code>name</code> member and a suitable icon.
          </li>
          <li>is served over a secure network connection.
          </li>
          <li>has a sensible content security policy.
          </li>
          <li>is able to responsively adapt to display on a variety of screen
          sizes, catering for both mobile and desktop.
          </li>
          <li>is able to function without a network connection.
          </li>
          <li>is repeatedly used by the end-user over some extended period of
          time.
          </li>
          <li>has been explicitly marked by the user as one that they value and
          trust (e.g., by bookmarking or "starring" it).
          </li>
        </ul>
        <p>
          This list is not exhaustive and some <a>installability signals</a>
          might not apply to all user agents. How a user agent makes use of
          these <a>installability signals</a> to determine if a web application
          can be <a>installed</a> is left to implementers.
        </p>
      </section>
    </section>
    <section>
      <h2>
        Installation Events
      </h2>
      <p>
        Installation events and supporting the {{BeforeInstallPrompt}} is
        OPTIONAL.
      </p>
      <p>
        DOM events <a>fired</a> by this specification use the <dfn>application
        life-cycle task source</dfn>.
      </p>
      <section data-dfn-for="BeforeInstallPromptEvent" data-link-for=
      "BeforeInstallPromptEvent">
        <h3>
          <dfn>BeforeInstallPromptEvent</dfn> Interface
        </h3>
        <div class="note">
          The <a>beforeinstallprompt</a> event is somewhat misnamed, as it does
          not necessarily signal that a <a>manual installation</a> will follow
          (depending on the user agent, it might just be giving the site the
          ability to trigger an install prompt). It is so named for historical
          reasons.
        </div>
        <pre class="idl" data-cite="DOM">
            [Exposed=Window]
            interface BeforeInstallPromptEvent : Event {
              constructor(DOMString type, optional EventInit eventInitDict = {});
              Promise&lt;PromptResponseObject&gt; prompt();
            };
  
            dictionary PromptResponseObject {
              AppBannerPromptOutcome userChoice;
            };
  
            enum AppBannerPromptOutcome {
              "accepted",
              "dismissed"
            };
          </pre>
        <p>
          The <a>BeforeInstallPromptEvent</a> is dispatched when the site is
          allowed to present a <a>site-triggered install prompt</a>, or prior
          to the user agent presenting an <a>automated install prompt</a>. It
          allows the site to cancel the <a>automated install prompt</a>, as
          well as manually present the <a>site-triggered install prompt</a>.
        </p>
        <div class="note">
          If the <a>BeforeInstallPromptEvent</a> is <em>not</em> cancelled, the
          user agent is allowed to <a>present an install prompt</a>
          (specifically, an <a>automated install prompt</a>) to the end-user.
          Canceling the default action (via {{Event/preventDefault()}})
          prevents the user agent from <a>presenting an install prompt</a>. The
          user agent is free to run <a>steps to notify that an install prompt
          is available</a> again at a later time.
        </div>
        <p data-dfn-for="PromptResponseObject">
          The <dfn>PromptResponseObject</dfn> contains the result of calling
          {{BeforeInstallPromptEvent\prompt()}}. It contains one member,
          <dfn data-link-for="PromptResponseObject">userChoice</dfn>, which
          states the user's chosen outcome.
        </p>
        <p>
          An instance of a <a>BeforeInstallPromptEvent</a> has the following
          internal slots:
        </p>
        <dl>
          <dt>
            <dfn>[[\didPrompt]]</dfn>
          </dt>
          <dd>
            A boolean, initially <code>false</code>. Represents whether this
            event was used to <a>present an install prompt</a> to the end-user.
          </dd>
          <dt>
            <dfn>[[\userResponsePromise]]</dfn>
          </dt>
          <dd>
            A promise that represents the outcome of <a>presenting an install
            prompt</a>.
          </dd>
        </dl>
        <section>
          <h4>
            <code>prompt()</code> method
          </h4>
          <p>
            The <dfn>prompt</dfn> method, when called, runs the following
            steps:
          </p>
          <ol>
            <li>If <var>this</var>.<a>[[\userResponsePromise]]</a> is pending:
              <ol>
                <li>If this event's <a data-cite=
                "DOM#dom-event-istrusted"><code>isTrusted</code></a> attribute
                is <code>false</code>, reject
                <var>this</var>.<a>[[\userResponsePromise]]</a> with
                {{"NotAllowedError"}}, optionally informing the developer that
                untrusted events can't call <code>prompt()</code>.
                </li>
                <li>Else if <var>this</var>.<a>[[\didPrompt]]</a> is
                <code>false</code>, set <var>this</var>.<a>[[\didPrompt]]</a>
                to <code>true</code>, then <a>in parallel</a>, <a>request to
                present an install prompt</a> with this event. Wait, possibly
                indefinitely, for the end-user to make a choice.
                </li>
              </ol>
            </li>
            <li>Return <var>this</var>.<a>[[\userResponsePromise]]</a>.
            </li>
          </ol>
          <p>
            To <dfn data-noexport="">request to present an install prompt</dfn>
            with <a>BeforeInstallPromptEvent</a> <var>event</var>:
          </p>
          <ol>
            <li>
              <a>Present an install prompt</a> and let <var>outcome</var> be
              the result.
            </li>
            <li>Resolve <var>event</var>.<a>[[\userResponsePromise]]</a> with a
            newly created <a>PromptResponseObject</a> whose <a data-link-for=
            "PromptResponseObject">userChoice</a> member is the value of <var>
              outcome</var>.
            </li>
          </ol>
        </section>
        <section class="informative">
          <h4>
            Usage example
          </h4>
          <p>
            This example shows how one might prevent an automated install
            prompt from showing until the user clicks a button to show a
            <a>site-triggered install prompt</a>. In this way, the site can
            leave installation at the user's discretion (rather than prompting
            at an arbitrary time), whilst still providing a prominent UI to do
            so.
          </p>
          <pre class="example" title=
          "Using beforeinstallprompt to present an install button">
              window.addEventListener("beforeinstallprompt", event =&gt; {
                // Suppress automatic prompting.
                event.preventDefault();
  
                // Show the (disabled-by-default) install button. This button
                // resolves the installButtonClicked promise when clicked.
                installButton.disabled = false;
  
                // Wait for the user to click the button.
                installButton.addEventListener("click", async e =&gt; {
                  // The prompt() method can only be used once.
                  installButton.disabled = true;
  
                  // Show the prompt.
                  const { userChoice } = await event.prompt();
                  console.info(`user choice was: ${userChoice}`);
                });
              });
            </pre>
        </section>
        <section data-dfn-for="AppBannerPromptOutcome">
          <h4>
            <code>AppBannerPromptOutcome</code> enum
          </h4>
          <p>
            The <dfn>AppBannerPromptOutcome</dfn> enum's values represent the
            outcomes from <a>presenting an install prompt</a>.
          </p>
          <dl data-dfn-for="AppBannerPromptOutcome">
            <dt>
              <dfn>accepted</dfn>:
            </dt>
            <dd>
              The end-user indicated that they would like the user agent to
              <a>install</a> the web application.
            </dd>
            <dt>
              <dfn>dismissed</dfn>:
            </dt>
            <dd>
              The end-user dismissed the install prompt.
            </dd>
          </dl>
        </section>
      </section>
      <section>
        <h3>
          Extensions to the <code>Window</code> object
        </h3>
        <p>
          The following extensions to the <code><dfn data-cite=
          "HTML/window-object.html#window">Window</dfn></code> object specify
          the <a>event handler idl attribute</a> on which events relating to
          the <a>installation</a> of a web application are <a>fired</a>.
        </p>
        <pre class="idl" data-cite="HTML">
          partial interface Window {
            attribute EventHandler onappinstalled;
            attribute EventHandler onbeforeinstallprompt;
          };
        </pre>
        <pre class="example js" title=
        "Two ways of handling the 'appinstalled' event">
          function handleInstalled(ev) {
            const date = new Date(ev.timeStamp / 1000);
            console.log(`Yay! Our app got installed at ${date.toTimeString()}.`);
          }

          // Using the event handler IDL attribute
          window.onappinstalled = handleInstalled;

          // Using .addEventListener()
          window.addEventListener("appinstalled", handleInstalled);
        </pre>
        <section data-dfn-for="Window">
          <h4>
            <code>onappinstalled</code> attribute
          </h4>
          <p>
            The <dfn>onappinstalled</dfn> is an <a>event handler IDL
            attribute</a> for the "<dfn>appinstalled</dfn>" event type. The
            interface used for these events is the <a><code>Event</code>
            interface</a> [[DOM]]. This event is dispatched as a result of a
            successful installation (see the <a>steps to install the web
            application</a>).
          </p>
        </section>
        <section data-dfn-for="Window">
          <h4>
            <code>onbeforeinstallprompt</code> attribute
          </h4>
          <p>
            The <dfn>onbeforeinstallprompt</dfn> is an <a>event handler IDL
            attribute</a> for the "<dfn>beforeinstallprompt</dfn>" event type.
            The interface used for these events is the
            <a>BeforeInstallPromptEvent</a> interface (see the <a>steps to
            notify that an install prompt is available</a>).
          </p>
        </section>
      </section>
    </section>
    <section id="linking">
      <h3>
        Linking to a manifest
      </h3>
      <p>
        The <code>manifest</code> keyword can be used with a [[HTML]] [^link^]
        element. This keyword creates an <a>external resource link</a>.
      </p>
      <table class="complex data">
        <thead>
          <tr>
            <th rowspan="2">
              Link type
            </th>
            <th colspan="2">
              Effect on...
            </th>
            <th rowspan="2">
              Brief description
            </th>
          </tr>
          <tr>
            <th>
              <code><a>link</a></code>
            </th>
            <th>
              <code><a>a</a></code> and <code><a>area</a></code>
            </th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <code>manifest</code>
            </td>
            <td>
              <a>External Resource Link</a>
            </td>
            <td>
              not allowed
            </td>
            <td>
              Imports or links to a <a>manifest</a>.
            </td>
          </tr>
        </tbody>
      </table>
      <p class="note">
        In cases where more than one [^link^] element with a
        <code>manifest</code> link type appears in a {{Document}}, the user
        agent uses the first [^link^] element in tree order and ignores all
        subsequent [^link^] elements with a <code>manifest</code> link type
        (even if the first element was erroneous). See the steps for
        <a>obtaining a manifest</a>.
      </p>
      <p>
        To obtain a manifest, the user agent MUST run the steps for <a data-lt=
        "obtaining the manifest">obtaining a manifest</a>. The appropriate time
        to obtain the manifest is left up to implementations. A user agent MAY
        opt to delay fetching a manifest until after the document and its other
        resources have been fully loaded (i.e., to not delay the availability
        of content and scripts required by the <a>document</a>).
      </p>
      <p>
        A <a>manifest</a> is obtained and applied regardless of the
        {{HTMLLinkElement/media}} attribute of the [^link^] element matches the
        environment or not.
      </p>
    </section>
  </body>
</html>
